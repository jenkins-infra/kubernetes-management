serviceAccount:
  create: false
  # TODO: track with updatecli from https://reports.jenkins.io/jenkins-infra-data-reports/azure.json
  name: jenkins-infra-controller
serviceAccountAgent:
  create: false
rbac:
  create: true
  readSecrets: true
persistence:
  enabled: true
  existingClaim: jenkins-infra-data
agent:
  componentName: "agent"
networkPolicy:
  enabled: true
  internalAgents:
    allowed: true
    namespaceLabels:
      name: "jenkins-infra"
controller:
  podLabels:
    "azure.workload.identity/use": "true"
  podSecurityContextOverride:
    runAsUser: 1000
    runAsNonRoot: true
    supplementalGroups: [1000]
    # fsGroup: 1000 # Uncomment once for new volumes
    # fsGroupChangePolicy: OnRootMismatch # Uncomment once for new volumes
  image:
    repository: jenkinsciinfra/jenkins-infraci
    tag: 3.9.5-2.520
    pullPolicy: IfNotPresent
  nodeSelector:
    kubernetes.io/os: linux
    kubernetes.azure.com/agentpool: infracictrl
    kubernetes.io/arch: arm64
  tolerations:
    - key: "kubernetes.io/arch"
      operator: "Equal"
      value: "arm64"
      effect: "NoSchedule"
    - key: "jenkins"
      operator: "Equal"
      value: "infra.ci.jenkins.io"
      effect: "NoSchedule"
    - key: "jenkins-component"
      operator: "Equal"
      value: "controller"
      effect: "NoSchedule"
  resources:
    limits:
      cpu: "2"
      memory: "8Gi"
    requests:
      cpu: "2"
      memory: "8Gi"
  probes:
    startupProbe:
      initialDelaySeconds: 60
    livenessProbe:
      initialDelaySeconds: 60
    readinessProbe:
      initialDelaySeconds: 60
  testEnabled: false
  # This setting deletes the content of $ JENKINS_HOME/plugins on each pod restart to ensure only container image plugins are used
  overwritePlugins: true
  javaOpts: >-
    -XshowSettings:vm -XX:+UseStringDeduplication -XX:+ParallelRefProcEnabled -XX:+DisableExplicitGC -XX:+AlwaysPreTouch -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/tmp/ -XX:+UseG1GC -Djava.net.preferIPv4Stack=true
  JCasC:
    enabled: true
    defaultConfig: false
    configScripts:
      credentials: |
        credentials:
          system:
            domainCredentials:
              - credentials:
                - gitHubApp:
                    appID: "${GITHUB_APP_ID}"
                    description: "GitHub App for infra.ci.jenkins.io"
                    id: "github-app-infra"
                    privateKey: "${GITHUB_APP_PRIVATE_KEY}"
                    scope: GLOBAL
                - azureImds:
                    azureEnvName: "Azure"
                    description: "infra.ci.jenkins.io's Azure Managed Identity used for spawning\
                      \ agents in the CDF subscription"
                    id: "azure-jenkins-cdf-managed-identity"
                    scope: SYSTEM
                    subscriptionId: "dff2ec18-6a8e-405c-8e45-b7df7465acf0"
                - usernamePassword:
                    description: "Credentials to access the azure agents VMs"
                    id: "azure-login"
                    password: "${AZURE_LOGIN_VM_PASS}"
                    scope: SYSTEM
                    username: "${AZURE_LOGIN_VM_USER}"
                - string:
                    description: "Token of the Service Account 'jenkins-agent' on the Kubernetes cluster 'infraci.jenkins.io-agents-2'"
                    id: "infraci.jenkins.io-agents-2-jenkins-agent-sa-token"
                    scope: SYSTEM
                    secret: "${INFRACIJENKINSIO_AGENTS_2_TOKEN}"
      agent-settings: |
        jenkins:
          numExecutors: 0
          updateCenter:
            sites:
              - id: "default"
                url: "https://azure.updates.jenkins.io/update-center.json"
          clouds:
            - kubernetes:
                containerCapStr: "100"
                credentialsId: "infraci.jenkins.io-agents-2-jenkins-agent-sa-token"
                serverCertificate: "${decodeBase64:${INFRACIJENKINSIO_AGENTS_2_CACRT}}"
                # TODO: track with updatecli from https://reports.jenkins.io/jenkins-infra-data-reports/azure.json
                serverUrl: "https://infracijenkinsioagents2-3myobbwc.hcp.eastus2.azmk8s.io:443"
                maxRequestsPerHostStr: "300"
                webSocket: true
                name: "kubernetes_infracijioagents2"
                namespace: "jenkins-infra-agents"
                podLabels:
                  - key: "jenkins"
                    value: "agent"
                  - key: "azure.workload.identity/use"
                    value: "true"
                podRetention: "Never"
                templates:
                  - name: jnlp-linux-amd64
                    nodeSelector: "kubernetes.io/arch=amd64"
                    containers:
                      - name: jnlp
                        image: "jenkinsciinfra/jenkins-agent-ubuntu-22.04:2.55.0"
                        command: "/usr/local/bin/jenkins-agent"
                        args: ""
                        envVars:
                        - envVar:
                            key: "JENKINS_JAVA_BIN"
                            value: "/opt/jdk-21/bin/java"
                        - envVar:
                            key: "JAVA_HOME"
                            value: "/opt/jdk-21"
                        resourceLimitMemory: "2048Mi"
                        resourceRequestCpu: "500m"
                        resourceRequestMemory: "512Mi"
                        alwaysPullImage: true
                    label: "linux jnlp-linux jnlp-linux-amd64"
                    # TODO: track with updatecli from https://reports.jenkins.io/jenkins-infra-data-reports/azure.json
                    serviceAccount: "jenkins-infra-agent"
                    yamlMergeStrategy: "merge"
                    yaml: |-
                      apiVersion: v1
                      kind: Pod
                      spec:
                        tolerations:
                        - key: "jenkins"
                          operator: "Equal"
                          value: "infra.ci.jenkins.io"
                          effect: "NoSchedule"
                        - key: "infra.ci.jenkins.io/agents"
                          operator: "Equal"
                          value: "true"
                          effect: "NoSchedule"
                        - key: "kubernetes.azure.com/scalesetpriority"
                          operator: "Equal"
                          value: "spot"
                          effect: "NoSchedule"
                  - name: jnlp-linux-arm64
                    nodeSelector: "kubernetes.io/arch=arm64"
                    containers:
                      - name: jnlp
                        image: "jenkinsciinfra/jenkins-agent-ubuntu-22.04:2.55.0"
                        command: "/usr/local/bin/jenkins-agent"
                        args: ""
                        envVars:
                        - envVar:
                            key: "JENKINS_JAVA_BIN"
                            value: "/opt/jdk-21/bin/java"
                        - envVar:
                            key: "JAVA_HOME"
                            value: "/opt/jdk-21"
                        resourceLimitMemory: "2048Mi"
                        resourceRequestCpu: "500m"
                        resourceRequestMemory: "512Mi"
                        alwaysPullImage: true
                    label: "jnlp-linux-arm64"
                    # TODO: track with updatecli from https://reports.jenkins.io/jenkins-infra-data-reports/azure.json
                    serviceAccount: "jenkins-infra-agent"
                    yamlMergeStrategy: "merge"
                    yaml: |-
                      apiVersion: v1
                      kind: Pod
                      spec:
                        tolerations:
                        - key: "jenkins"
                          operator: "Equal"
                          value: "infra.ci.jenkins.io"
                          effect: "NoSchedule"
                        - key: "kubernetes.io/arch"
                          operator: "Equal"
                          value: "arm64"
                          effect: "NoSchedule"
                        - key: "infra.ci.jenkins.io/agents"
                          operator: "Equal"
                          value: "true"
                          effect: "NoSchedule"
                        - key: "kubernetes.azure.com/scalesetpriority"
                          operator: "Equal"
                          value: "spot"
                          effect: "NoSchedule"
                  - name: jnlp-webbuilder
                    nodeSelector: "kubernetes.io/arch=amd64"
                    containers:
                      - name: jnlp
                        image: "jenkinsciinfra/builder@sha256:7150f769249c071fec7ee18338183193c36d489dc9a2fb2d211242fcc89350cd"
                        command: "/usr/local/bin/jenkins-agent"
                        args: ""
                        envVars:
                        - envVar:
                            key: "JENKINS_JAVA_OPTS"
                            value: "-XX:+PrintCommandLineFlags"
                        - envVar:
                            key: "JENKINS_JAVA_BIN"
                            value: "/opt/jdk-21/bin/java"
                        - envVar:
                            key: "JAVA_HOME"
                            value: "/opt/java/openjdk/bin/java"
                        - envVar:
                            key: "PATH"
                            value: "~/.asdf/shims:~/.asdf/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin"
                        resourceLimitMemory: "8G"
                        resourceRequestCpu: "500m"
                        resourceRequestMemory: "1G"
                        alwaysPullImage: true
                    label: "container kubernetes node ruby webbuilder"
                    # TODO: track with updatecli from https://reports.jenkins.io/jenkins-infra-data-reports/azure.json
                    serviceAccount: "jenkins-infra-agent"
                    yamlMergeStrategy: "merge"
                    yaml: |-
                      apiVersion: v1
                      kind: Pod
                      spec:
                        tolerations:
                        - key: "jenkins"
                          operator: "Equal"
                          value: "infra.ci.jenkins.io"
                          effect: "NoSchedule"
                        - key: "infra.ci.jenkins.io/agents"
                          operator: "Equal"
                          value: "true"
                          effect: "NoSchedule"
                        - key: "kubernetes.azure.com/scalesetpriority"
                          operator: "Equal"
                          value: "spot"
                          effect: "NoSchedule"
            - azureVM:
                azureCredentialsId: "azure-jenkins-cdf-managed-identity"
                name: "azure-vms-jenkins-cdf"
                deploymentTimeout: 1200
                existingResourceGroupName: "infra-ci-jenkins-io-ephemeral-agents"
                maxVirtualMachinesLimit: 50
                resourceGroupReferenceType: "existing"
                vmTemplates:
                - launcher: "ssh"
                  agentWorkspace: "/home/jenkins"
                  credentialsId: "azure-login"
                  diskType: "managed"
                  doNotUseMachineIfInitFails: false
                  encryptionAtHost: true
                  ephemeralOSDisk: true
                  executeInitScriptAsRoot: true
                  imageReference:
                    galleryImageDefinition: "jenkins-agent-ubuntu-22.04-amd64"
                    galleryImageVersion: "2.55.0"
                    galleryName: "prod_packer_images"
                    galleryResourceGroup: "prod-packer-images"
                    gallerySubscriptionId: "dff2ec18-6a8e-405c-8e45-b7df7465acf0"
                  imageTopLevelType: "advanced"
                  initScript: |-
                    #!/bin/bash
                    set -eux
                    echo "START CLOUDINIT"
                    # Setup Datadog service
                    (
                      systemctl stop datadog-agent.service
                      mkdir -p /var/log/datadog /etc/datadog-agent
                      sed 's/api_key:.*/api_key: ${JENKINS_CI_DATADOG_API_KEY}/' /etc/datadog-agent/datadog.yaml.example > /etc/datadog-agent/datadog.yaml
                      sed -i 's/# site:.*/site: datadoghq.com/' /etc/datadog-agent/datadog.yaml
                      chown dd-agent:dd-agent /etc/datadog-agent/datadog.yaml
                      chmod 640 /etc/datadog-agent/datadog.yaml
                      chown dd-agent:dd-agent /var/log/datadog
                      chmod 770 /var/log/datadog
                      systemctl daemon-reload
                      systemctl enable datadog-agent.service
                      systemctl start datadog-agent.service
                    ) 2>&1 | tee /var/log/agent-init-datadog.log
                    # Setup Docker Engine
                    mkdir -p /etc/docker
                    cat <<EOF >/etc/docker/daemon.json
                    {
                      "registry-mirrors": ["https://dockerhubmirror.azurecr.io"]
                    }
                    EOF
                    systemctl daemon-reload
                    systemctl restart docker
                    export DEFAULT_JDK=/opt/jdk-11
                    update-alternatives --install /usr/bin/java java "^${DEFAULT_JDK}/bin/java" 2000
                    echo "JAVA_HOME=^${DEFAULT_JDK}" >> /etc/environment
                    rm -f /etc/sudoers.d/90-cloud-init-users
                    echo "END CLOUDINIT"
                  javaPath: "/opt/jdk-21/bin/java"
                  jvmOptions: "-XX:+PrintCommandLineFlags"
                  labels: "linux-amd64 linux-amd64-docker"
                  location: "East US 2"
                  maxVirtualMachinesLimit: 50
                  existingStorageAccountName: "infracijenkinsioagents"
                  noOfParallelJobs: 1
                  osDiskSize: 150
                  osDiskStorageAccountType: "Standard_LRS"
                  osType: "Linux"
                  retentionStrategy: "azureVMCloudOnce"
                  spotInstance: true
                  storageAccountNameReferenceType: "existing"
                  storageAccountType: "Standard_LRS"
                  subnetName: "infra-ci-jenkins-io-vnet-ephemeral-agents"
                  templateDesc: "Dynamically provisioned Ubuntu 22.04 LTS x86_64 machine"
                  templateName: "ubuntu-22"
                  enableUAMI: true
                  uamiID: "/subscriptions/dff2ec18-6a8e-405c-8e45-b7df7465acf0/resourceGroups/infra-ci-jenkins-io-controller/providers/Microsoft.ManagedIdentity/userAssignedIdentities/infra-ci-jenkins-io-agents"
                  usageMode: NORMAL
                  usePrivateIP: true
                  virtualMachineSize: "Standard_D4ads_v5" # 4 vCPUS / 16 Gb / Max 150 Gb local storage
                  virtualNetworkName: "infra-ci-jenkins-io-vnet"
                  virtualNetworkResourceGroupName: "infra-ci-jenkins-io"
                - launcher: "ssh"
                  agentWorkspace: "C:/Jenkins"
                  credentialsId: "azure-login"
                  diskType: "managed"
                  doNotUseMachineIfInitFails: true
                  encryptionAtHost: true
                  ephemeralOSDisk: true
                  executeInitScriptAsRoot: true
                  imageReference:
                    galleryImageDefinition: "jenkins-agent-windows-2019-amd64"
                    galleryImageVersion: "2.55.0"
                    galleryName: "prod_packer_images"
                    galleryResourceGroup: "prod-packer-images"
                    gallerySubscriptionId: "dff2ec18-6a8e-405c-8e45-b7df7465acf0"
                  imageTopLevelType: "advanced"
                  initScript: |-
                    (Get-Content C:\ProgramData\Datadog\datadog.yaml -Raw) -Replace 'api_key:', 'api_key: ${JENKINS_CI_DATADOG_API_KEY}' | Set-Content C:\ProgramData\Datadog\datadog.yaml
                    & "$env:ProgramFiles\Datadog\Datadog Agent\bin\agent.exe" restart-service
                    # Setup Docker Engine
                    @'
                    {
                      "registry-mirrors": ["https://dockerhubmirror.azurecr.io"]
                    }
                    '@ | Set-Content C:\ProgramData\Docker\config\daemon.json
                    Restart-Service docker
                  javaPath: "C:/tools/jdk-21/bin/java"
                  jvmOptions: "-XX:+PrintCommandLineFlags"
                  labels: "windows-2019 amd64 azure vm docker-windows docker-windows-2019 windows"
                  location: "East US 2"
                  maxVirtualMachinesLimit: 50
                  existingStorageAccountName: "infracijenkinsioagents"
                  noOfParallelJobs: 1
                  osDiskSize: 150
                  osDiskStorageAccountType: "Standard_LRS"
                  osType: "Windows"
                  retentionStrategy: "azureVMCloudOnce"
                  spotInstance: true
                  storageAccountNameReferenceType: "existing"
                  storageAccountType: "Standard_LRS"
                  subnetName: "infra-ci-jenkins-io-vnet-ephemeral-agents"
                  templateDesc: "Dynamically provisioned Windows 2019 machine"
                  templateName: "win-2019"
                  enableUAMI: true
                  uamiID: "/subscriptions/dff2ec18-6a8e-405c-8e45-b7df7465acf0/resourceGroups/infra-ci-jenkins-io-controller/providers/Microsoft.ManagedIdentity/userAssignedIdentities/infra-ci-jenkins-io-agents"
                  usageMode: NORMAL
                  usePrivateIP: true
                  virtualMachineSize: "Standard_D4ads_v5" # 4 vCPUS / 16 Gb / Max 150 Gb local storage
                  virtualNetworkName: "infra-ci-jenkins-io-vnet"
                  virtualNetworkResourceGroupName: "infra-ci-jenkins-io"
                - launcher: "ssh"
                  agentWorkspace: "C:/Jenkins"
                  credentialsId: "azure-login"
                  diskType: "managed"
                  doNotUseMachineIfInitFails: true
                  encryptionAtHost: true
                  ephemeralOSDisk: true
                  executeInitScriptAsRoot: true
                  imageReference:
                    galleryImageDefinition: "jenkins-agent-windows-2022-amd64"
                    galleryImageVersion: "2.55.0"
                    galleryName: "prod_packer_images"
                    galleryResourceGroup: "prod-packer-images"
                    gallerySubscriptionId: "dff2ec18-6a8e-405c-8e45-b7df7465acf0"
                  imageTopLevelType: "advanced"
                  initScript: |-
                    (Get-Content C:\ProgramData\Datadog\datadog.yaml -Raw) -Replace 'api_key:', 'api_key: ${JENKINS_CI_DATADOG_API_KEY}' | Set-Content C:\ProgramData\Datadog\datadog.yaml
                    & "$env:ProgramFiles\Datadog\Datadog Agent\bin\agent.exe" restart-service
                    # Setup Docker Engine
                    @'
                    {
                      "registry-mirrors": ["https://dockerhubmirror.azurecr.io"]
                    }
                    '@ | Set-Content C:\ProgramData\Docker\config\daemon.json
                    Restart-Service docker
                  javaPath: "C:/tools/jdk-21/bin/java"
                  jvmOptions: "-XX:+PrintCommandLineFlags"
                  labels: "windows-2022 amd64 azure vm docker-windows docker-windows-2022 windows"
                  location: "East US 2"
                  maxVirtualMachinesLimit: 50
                  existingStorageAccountName: "infracijenkinsioagents"
                  noOfParallelJobs: 1
                  osDiskSize: 150
                  osDiskStorageAccountType: "Standard_LRS"
                  osType: "Windows"
                  retentionStrategy: "azureVMCloudOnce"
                  spotInstance: true
                  storageAccountNameReferenceType: "existing"
                  storageAccountType: "Standard_LRS"
                  subnetName: "infra-ci-jenkins-io-vnet-ephemeral-agents"
                  templateDesc: "Dynamically provisioned Windows 2022 machine"
                  templateName: "win-2022"
                  enableUAMI: true
                  uamiID: "/subscriptions/dff2ec18-6a8e-405c-8e45-b7df7465acf0/resourceGroups/infra-ci-jenkins-io-controller/providers/Microsoft.ManagedIdentity/userAssignedIdentities/infra-ci-jenkins-io-agents"
                  usageMode: NORMAL
                  usePrivateIP: true
                  virtualMachineSize: "Standard_D4ads_v5" # 4 vCPUS / 16 Gb / Max 150 Gb local storage
                  virtualNetworkName: "infra-ci-jenkins-io-vnet"
                  virtualNetworkResourceGroupName: "infra-ci-jenkins-io"
                - launcher: "ssh"
                  agentWorkspace: "/home/jenkins"
                  credentialsId: "azure-login"
                  diskType: "managed"
                  doNotUseMachineIfInitFails: false
                  encryptionAtHost: true
                  ephemeralOSDisk: true
                  executeInitScriptAsRoot: true
                  imageReference:
                    galleryImageDefinition: "jenkins-agent-ubuntu-22.04-arm64"
                    galleryImageVersion: "2.55.0"
                    galleryName: "prod_packer_images"
                    galleryResourceGroup: "prod-packer-images"
                    gallerySubscriptionId: "dff2ec18-6a8e-405c-8e45-b7df7465acf0"
                  imageTopLevelType: "advanced"
                  initScript: |-
                    #!/bin/bash
                    set -eux
                    echo "START CLOUDINIT"
                    # Setup Datadog service
                    (
                      systemctl stop datadog-agent.service
                      mkdir -p /var/log/datadog /etc/datadog-agent
                      sed 's/api_key:.*/api_key: ${JENKINS_CI_DATADOG_API_KEY}/' /etc/datadog-agent/datadog.yaml.example > /etc/datadog-agent/datadog.yaml
                      sed -i 's/# site:.*/site: datadoghq.com/' /etc/datadog-agent/datadog.yaml
                      chown dd-agent:dd-agent /etc/datadog-agent/datadog.yaml
                      chmod 640 /etc/datadog-agent/datadog.yaml
                      chown dd-agent:dd-agent /var/log/datadog
                      chmod 770 /var/log/datadog
                      systemctl daemon-reload
                      systemctl enable datadog-agent.service
                      systemctl start datadog-agent.service
                    ) 2>&1 | tee /var/log/agent-init-datadog.log
                    # Setup Docker Engine
                    mkdir -p /etc/docker
                    cat <<EOF >/etc/docker/daemon.json
                    {
                      "registry-mirrors": ["https://dockerhubmirror.azurecr.io"]
                    }
                    EOF
                    systemctl daemon-reload
                    systemctl restart docker
                    export DEFAULT_JDK=/opt/jdk-11
                    update-alternatives --install /usr/bin/java java "^${DEFAULT_JDK}/bin/java" 2000
                    echo "JAVA_HOME=^${DEFAULT_JDK}" >> /etc/environment
                    rm -f /etc/sudoers.d/90-cloud-init-users
                    echo "END CLOUDINIT"
                  javaPath: "/opt/jdk-21/bin/java"
                  jvmOptions: "-XX:+PrintCommandLineFlags"
                  labels: "linux-arm64 linux-arm64-docker arm64linux jdk11 maven-11 ubuntu-22-arm64 ubuntu-arm64"
                  location: "East US 2"
                  maxVirtualMachinesLimit: 50
                  existingStorageAccountName: "infracijenkinsioagents"
                  noOfParallelJobs: 1
                  osDiskSize: 100 # https://github.com/jenkins-infra/helpdesk/issues/3812
                  osDiskStorageAccountType: "Standard_LRS"
                  osType: "Linux"
                  retentionStrategy: "azureVMCloudOnce"
                  spotInstance: true
                  storageAccountNameReferenceType: "existing"
                  storageAccountType: "Standard_LRS"
                  subnetName: "infra-ci-jenkins-io-vnet-ephemeral-agents"
                  templateDesc: "Dynamically provisioned Ubuntu 22.04 LTS arm64 machine"
                  templateName: "ubuntu-22-arm64"
                  enableUAMI: true
                  uamiID: "/subscriptions/dff2ec18-6a8e-405c-8e45-b7df7465acf0/resourceGroups/infra-ci-jenkins-io-controller/providers/Microsoft.ManagedIdentity/userAssignedIdentities/infra-ci-jenkins-io-agents"
                  usageMode: NORMAL
                  usePrivateIP: true
                  virtualMachineSize: "Standard_D4pds_v5" # 4 vCPUS / 16 Gb / Max 100 Gb OsCacheDisk local storage (150 temp)
                  virtualNetworkName: "infra-ci-jenkins-io-vnet"
                  virtualNetworkResourceGroupName: "infra-ci-jenkins-io"
                - launcher: "ssh"
                  agentWorkspace: "/home/jenkins"
                  credentialsId: "azure-login"
                  diskType: "managed"
                  doNotUseMachineIfInitFails: false
                  encryptionAtHost: true
                  ephemeralOSDisk: true
                  executeInitScriptAsRoot: true
                  imageReference:
                    galleryImageDefinition: "jenkins-agent-ubuntu-22.04-arm64"
                    galleryImageVersion: "2.55.0"
                    galleryName: "prod_packer_images"
                    galleryResourceGroup: "prod-packer-images"
                    gallerySubscriptionId: "dff2ec18-6a8e-405c-8e45-b7df7465acf0"
                  imageTopLevelType: "advanced"
                  initScript: |-
                    #!/bin/bash
                    set -eux
                    echo "START CLOUDINIT"
                    # Setup Datadog service
                    (
                      systemctl stop datadog-agent.service
                      mkdir -p /var/log/datadog /etc/datadog-agent
                      sed 's/api_key:.*/api_key: ${JENKINS_CI_DATADOG_API_KEY}/' /etc/datadog-agent/datadog.yaml.example > /etc/datadog-agent/datadog.yaml
                      sed -i 's/# site:.*/site: datadoghq.com/' /etc/datadog-agent/datadog.yaml
                      chown dd-agent:dd-agent /etc/datadog-agent/datadog.yaml
                      chmod 640 /etc/datadog-agent/datadog.yaml
                      chown dd-agent:dd-agent /var/log/datadog
                      chmod 770 /var/log/datadog
                      systemctl daemon-reload
                      systemctl enable datadog-agent.service
                      systemctl start datadog-agent.service
                    ) 2>&1 | tee /var/log/agent-init-datadog.log
                    # Setup Docker Engine
                    mkdir -p /etc/docker
                    cat <<EOF >/etc/docker/daemon.json
                    {
                      "registry-mirrors": ["https://dockerhubmirror.azurecr.io"]
                    }
                    EOF
                    systemctl daemon-reload
                    systemctl restart docker
                    export DEFAULT_JDK=/opt/jdk-17
                    update-alternatives --install /usr/bin/java java "^${DEFAULT_JDK}/bin/java" 2000
                    echo "JAVA_HOME=^${DEFAULT_JDK}" >> /etc/environment
                    rm -f /etc/sudoers.d/90-cloud-init-users
                    echo "END CLOUDINIT"
                  javaPath: "/opt/jdk-21/bin/java"
                  jvmOptions: "-XX:+PrintCommandLineFlags"
                  labels: "linux-arm64-maven-17 jdk17 maven-17 ubuntu-22-arm64-maven-17 ubuntu-arm64-maven-17"
                  location: "East US 2"
                  maxVirtualMachinesLimit: 50
                  existingStorageAccountName: "infracijenkinsioagents"
                  noOfParallelJobs: 1
                  osDiskSize: 100 # https://github.com/jenkins-infra/helpdesk/issues/3812
                  osDiskStorageAccountType: "Standard_LRS"
                  osType: "Linux"
                  retentionStrategy: "azureVMCloudOnce"
                  spotInstance: true
                  storageAccountNameReferenceType: "existing"
                  storageAccountType: "Standard_LRS"
                  subnetName: "infra-ci-jenkins-io-vnet-ephemeral-agents"
                  templateDesc: "Dynamically provisioned Ubuntu 22.04 maven-17 LTS arm64 machine"
                  templateName: "ubuntu-22-arm64-maven-17"
                  enableUAMI: true
                  uamiID: "/subscriptions/dff2ec18-6a8e-405c-8e45-b7df7465acf0/resourceGroups/infra-ci-jenkins-io-controller/providers/Microsoft.ManagedIdentity/userAssignedIdentities/infra-ci-jenkins-io-agents"
                  usageMode: NORMAL
                  usePrivateIP: true
                  virtualMachineSize: "Standard_D4pds_v5" # 4 vCPUS / 16 Gb / Max 100 Gb OsCacheDisk local storage (150 temp)
                  virtualNetworkName: "infra-ci-jenkins-io-vnet"
                  virtualNetworkResourceGroupName: "infra-ci-jenkins-io"
                - launcher: "ssh"
                  agentWorkspace: "/home/jenkins"
                  credentialsId: "azure-login"
                  diskType: "managed"
                  doNotUseMachineIfInitFails: false
                  encryptionAtHost: true
                  ephemeralOSDisk: true
                  executeInitScriptAsRoot: true
                  imageReference:
                    galleryImageDefinition: "jenkins-agent-ubuntu-22.04-arm64"
                    galleryImageVersion: "2.55.0"
                    galleryName: "prod_packer_images"
                    galleryResourceGroup: "prod-packer-images"
                    gallerySubscriptionId: "dff2ec18-6a8e-405c-8e45-b7df7465acf0"
                  imageTopLevelType: "advanced"
                  initScript: |-
                    #!/bin/bash
                    set -eux
                    echo "START CLOUDINIT"
                    # Setup Datadog service
                    (
                      systemctl stop datadog-agent.service
                      mkdir -p /var/log/datadog /etc/datadog-agent
                      sed 's/api_key:.*/api_key: ${JENKINS_CI_DATADOG_API_KEY}/' /etc/datadog-agent/datadog.yaml.example > /etc/datadog-agent/datadog.yaml
                      sed -i 's/# site:.*/site: datadoghq.com/' /etc/datadog-agent/datadog.yaml
                      chown dd-agent:dd-agent /etc/datadog-agent/datadog.yaml
                      chmod 640 /etc/datadog-agent/datadog.yaml
                      chown dd-agent:dd-agent /var/log/datadog
                      chmod 770 /var/log/datadog
                      systemctl daemon-reload
                      systemctl enable datadog-agent.service
                      systemctl start datadog-agent.service
                    ) 2>&1 | tee /var/log/agent-init-datadog.log
                    # Setup Docker Engine
                    mkdir -p /etc/docker
                    cat <<EOF >/etc/docker/daemon.json
                    {
                      "registry-mirrors": ["https://dockerhubmirror.azurecr.io"]
                    }
                    EOF
                    systemctl daemon-reload
                    systemctl restart docker
                    export DEFAULT_JDK=/opt/jdk-21
                    update-alternatives --install /usr/bin/java java "^${DEFAULT_JDK}/bin/java" 2000
                    echo "JAVA_HOME=^${DEFAULT_JDK}" >> /etc/environment
                    rm -f /etc/sudoers.d/90-cloud-init-users
                    echo "END CLOUDINIT"
                  javaPath: "/opt/jdk-21/bin/java"
                  jvmOptions: "-XX:+PrintCommandLineFlags"
                  labels: "linux-arm64-maven-21 jdk21 maven-21 ubuntu-22-arm64-maven-21 ubuntu-arm64-maven-21"
                  location: "East US 2"
                  maxVirtualMachinesLimit: 50
                  existingStorageAccountName: "infracijenkinsioagents"
                  noOfParallelJobs: 1
                  osDiskSize: 100 # https://github.com/jenkins-infra/helpdesk/issues/3812
                  osDiskStorageAccountType: "Standard_LRS"
                  osType: "Linux"
                  retentionStrategy: "azureVMCloudOnce"
                  spotInstance: true
                  storageAccountNameReferenceType: "existing"
                  storageAccountType: "Standard_LRS"
                  subnetName: "infra-ci-jenkins-io-vnet-ephemeral-agents"
                  templateDesc: "Dynamically provisioned Ubuntu 22.04 maven-21 LTS arm64 machine"
                  templateName: "ubuntu-22-arm64-maven-21"
                  enableUAMI: true
                  uamiID: "/subscriptions/dff2ec18-6a8e-405c-8e45-b7df7465acf0/resourceGroups/infra-ci-jenkins-io-controller/providers/Microsoft.ManagedIdentity/userAssignedIdentities/infra-ci-jenkins-io-agents"
                  usageMode: NORMAL
                  usePrivateIP: true
                  virtualMachineSize: "Standard_D4pds_v5" # 4 vCPUS / 16 Gb / Max 100 Gb OsCacheDisk local storage (150 temp)
                  virtualNetworkName: "infra-ci-jenkins-io-vnet"
                  virtualNetworkResourceGroupName: "infra-ci-jenkins-io"
      security: |
        security:
          scriptApproval:
            approvedSignatures:
              - "method org.jenkinsci.plugins.workflow.steps.FlowInterruptedException getCauses"
              - "new java.lang.RuntimeException java.lang.Throwable"
          gitHostKeyVerificationConfiguration:
            sshHostKeyVerificationStrategy:
              manuallyProvidedKeyVerificationStrategy:
                approvedHostKeys: "github.com ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOMqqnkVzrm0SdG6UOoqKLsabgH5C9okWi0dh2l9GKJl"
      ldap-settings: |
        jenkins:
          securityRealm:
            ldap:
              configurations:
                - server: "${LDAP_SERVER}"
                  rootDN: "${LDAP_ROOT_DN}"
                  managerDN: "${LDAP_MANAGER_DN}"
                  managerPasswordSecret: "${LDAP_MANAGER_PASSWORD}"
                  mailAddressAttributeName: "mail"
                  userSearch: cn={0}
                  userSearchBase: "ou=people"
                  groupSearchBase: "ou=groups"
              disableMailAddressResolver: false
              groupIdStrategy: "caseInsensitive"
              userIdStrategy: "caseInsensitive"
              cache:
                size: 100
                ttl: 300
      advisor-settings: |
        jenkins:
          disabledAdministrativeMonitors:
            - com.cloudbees.jenkins.plugins.advisor.Reminder
        advisor:
          acceptToS: true
          ccs:
          - "damien.duportal@gmail.com"
          email: "jenkins-infra-team@googlegroups.com"
          excludedComponents:
            - "ItemsContent"
            - "GCLogs"
            - "Agents"
            - "RootCAs"
            - "SlaveLogs"
            - "HeapUsageHistogram"
          nagDisabled: true
      pipeline-library: |
        unclassified:
          location:
            url: "https://infra.ci.jenkins.io"
          globalLibraries:
            libraries:
            - cachingConfiguration:
                excludedVersionsStr: "pull/"
                refreshTimeMinutes: 180
              defaultVersion: "master"
              implicit: true
              name: "pipeline-library"
              includeInChangesets: false
              retriever:
                modernSCM:
                  scm:
                    git:
                      credentialsId: "github-app-infra"
                      remote: "https://github.com/jenkins-infra/pipeline-library.git"
      matrix-settings: |
        jenkins:
          authorizationStrategy:
            globalMatrix:
              entries:
              - group:
                  name: "admins"
                  permissions:
                  - "Overall/Administer"
              - group:
                  name: "authenticated"
                  permissions:
                  - "Job/Build"
                  - "Job/ExtendedRead"
                  - "Job/Read"
                  - "Overall/Read"
                  - "Overall/SystemRead"
              - group:
                  name: "jenkins-admins"
                  permissions:
                  - "Overall/Administer"
      pipeline-settings: |
        unclassified:
          timestamper:
            allPipelines: true
          shell:
            shell: "/bin/bash"
      system-settings: |
        unclassified:
          gitHubConfiguration:
            apiRateLimitChecker: NoThrottle
          lockableResourcesManager:
            declaredResources:
            - description: "first entry for packer image builder dev"
              labels: "dev-packerimage"
              name: "dev-1"
              reservedBy: "PackerImages"
            - description: "second entry for packer image builder dev"
              labels: "dev-packerimage"
              name: "dev-2"
              reservedBy: "PackerImages"
            - description: "third entry for packer image builder dev"
              labels: "dev-packerimage"
              name: "dev-3"
              reservedBy: "PackerImages"
            - description: "fourth entry for packer image builder dev"
              labels: "dev-packerimage"
              name: "dev-4"
              reservedBy: "PackerImages"
            - description: "fifh entry for packer image builder dev"
              labels: "dev-packerimage"
              name: "dev-5"
              reservedBy: "PackerImages"
            - description: "first entry for packer image builder staging"
              labels: "staging-packerimage"
              name: "staging-1"
              reservedBy: "PackerImages"
            - description: "first entry for packer image builder prod"
              labels: "prod-packerimage"
              name: "prod-1"
              reservedBy: "PackerImages"
          defaultFolderConfiguration:
            # Keep healthMetrics an empty list to ensure weather is disabled
            healthMetrics: []
        jenkins:
          quietPeriod: 0 # No need to wait between build scheduling
          disabledAdministrativeMonitors:
            - "jenkins.security.QueueItemAuthenticatorMonitor"
        appearance:
          pipelineGraphView:
            showGraphOnBuildPage: true
            showGraphOnJobPage: true
      tools-config: |
        tool:
          git:
            installations:
            - home: "git"
              name: "git-native"
            - name: "jgit"
          jdk:
            installations:
            - name: "jdk8"
              properties:
              - installSource:
                  installers:
                  - zip:
                      label: "linux && amd64"
                      subdir: "jdk8u462-b08"
                      url: "https://github.com/adoptium/temurin8-binaries/releases/download/jdk8u462-b08/OpenJDK8U-jdk_x64_linux_hotspot_8u462b08.tar.gz"
                  - zip:
                      label: "windows"
                      subdir: "jdk8u462-b08"
                      url: "https://github.com/adoptium/temurin8-binaries/releases/download/jdk8u462-b08/OpenJDK8U-jdk_x64_windows_hotspot_8u462b08.zip"
                  - zip:
                      label: "linux && arm64"
                      subdir: "jdk8u462-b08"
                      url: "https://github.com/adoptium/temurin8-binaries/releases/download/jdk8u462-b08/OpenJDK8U-jdk_aarch64_linux_hotspot_8u462b08.tar.gz"
            - name: "jdk11"
              properties:
              - installSource:
                  installers:
                  - zip:
                      label: "linux && amd64"
                      subdir: "jdk-11.0.28+6"
                      url: "https://github.com/adoptium/temurin11-binaries/releases/download/jdk-11.0.28%2B6/OpenJDK11U-jdk_x64_linux_hotspot_11.0.28_6.tar.gz"
                  - zip:
                      label: "windows"
                      subdir: "jdk-11.0.28+6"
                      url: "https://github.com/adoptium/temurin11-binaries/releases/download/jdk-11.0.28%2B6/OpenJDK11U-jdk_x64_windows_hotspot_11.0.28_6.zip"
                  - zip:
                      label: "linux && arm64"
                      subdir: "jdk-11.0.28+6"
                      url: "https://github.com/adoptium/temurin11-binaries/releases/download/jdk-11.0.28%2B6/OpenJDK11U-jdk_aarch64_linux_hotspot_11.0.28_6.tar.gz"
            - name: "jdk17"
              properties:
              - installSource:
                  installers:
                  - zip:
                      label: "linux && amd64"
                      subdir: "jdk-17.0.16+8"
                      url: "https://github.com/adoptium/temurin17-binaries/releases/download/jdk-17.0.16%2B8/OpenJDK17U-jdk_x64_linux_hotspot_17.0.16_8.tar.gz"
                  - zip:
                      label: "windows"
                      subdir: "jdk-17.0.16+8"
                      url: "https://github.com/adoptium/temurin17-binaries/releases/download/jdk-17.0.16%2B8/OpenJDK17U-jdk_x64_windows_hotspot_17.0.16_8.zip"
                  - zip:
                      label: "linux && arm64"
                      subdir: "jdk-17.0.16+8"
                      url: "https://github.com/adoptium/temurin17-binaries/releases/download/jdk-17.0.16%2B8/OpenJDK17U-jdk_aarch64_linux_hotspot_17.0.16_8.tar.gz"
            - name: "jdk21"
              properties:
              - installSource:
                  installers:
                  - zip:
                      label: "linux && amd64"
                      subdir: "jdk-21.0.8+9"
                      url: "https://github.com/adoptium/temurin21-binaries/releases/download/jdk-21.0.8%2B9/OpenJDK21U-jdk_x64_linux_hotspot_21.0.8_9.tar.gz"
                  - zip:
                      label: "windows"
                      subdir: "jdk-21.0.8+9"
                      url: "https://github.com/adoptium/temurin21-binaries/releases/download/jdk-21.0.8%2B9/OpenJDK21U-jdk_x64_windows_hotspot_21.0.8_9.zip"
                  - zip:
                      label: "linux && arm64"
                      subdir: "jdk-21.0.8+9"
                      url: "https://github.com/adoptium/temurin21-binaries/releases/download/jdk-21.0.8%2B9/OpenJDK21U-jdk_aarch64_linux_hotspot_21.0.8_9.tar.gz"
          maven:
            installations:
            - name: "mvn"
              properties:
              - installSource:
                  installers:
                  - maven:
                      id: "3.9.11"
      custom-header: |
        appearance:
          customHeader:
            enabled: true
            header: "logo"
            headerColor:
              backgroundColor: "linear-gradient(90deg, rgba(239,192,92,1) 0%, rgba(171,28,28,1) 100%);"
              color: "white"
            logo:
              image:
                logoUrl: "https://infra.ci.jenkins.io/userContent/logos/beekeeper.png"
            logoText: "Jenkins Infra"
      default-notification-url: |
        unclassified:
          defaultDisplayUrlProvider:
            providerId: "org.jenkinsci.plugins.displayurlapi.ClassicDisplayURLProvider"
  installPlugins: false
  ingress:
    enabled: true
    hostName: infra.ci.jenkins.io
    annotations:
      "cert-manager.io/cluster-issuer": "letsencrypt-prod"
      "nginx.ingress.kubernetes.io/proxy-body-size": "500m"
    ingressClassName: private-nginx
    tls:
      - hosts:
          - infra.ci.jenkins.io
        secretName: infra.ci.jenkins.io-cert
  secondaryingress:
    enabled: true
    paths:
      - /github-webhook
    hostName: infra-webhooks.ci.jenkins.io
    ingressClassName: public-nginx
    annotations:
      "cert-manager.io/cluster-issuer": "letsencrypt-prod"
      "nginx.ingress.kubernetes.io/ssl-redirect": "true"
    tls:
      - hosts:
          - infra-webhooks.ci.jenkins.io
        secretName: infra-webhooks.ci.jenkins.io-cert
