name: Update allowed GitHub hooks IPs

scms:
  default:
    kind: github
    spec:
      user: "{{ .github.user }}"
      email: "{{ .github.email }}"
      owner: "{{ .github.owner }}"
      repository: "{{ .github.repository }}"
      token: "{{ requiredEnv .github.token }}"
      username: "{{ .github.username }}"
      branch: "{{ .github.branch }}"

sources:
  githubHooksIps:
    kind: shell
    name: get GitHub hooks IPs
    spec:
      command: curl https://api.github.com/meta | jq -r '.hooks | sort | join(",")'

targets:
  allowIPs:
    name: Update allowed IPs
    kind: yaml
    scmid: default
    spec:
      file: config/public-nginx-ingress_privatek8s.yaml
      key: controller.config.whitelist-source-range

actions:
  default:
    kind: github/pullrequest
    scmid: default
    title: Update allowed GitHub hooks IPs in the public Nginx of privatek8s
    spec:
      labels:
        - public-nginx
        - privatek8s
        - github-hooks-ips
